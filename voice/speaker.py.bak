"""
Voice Speaker
Uses Piper TTS for fast, offline, natural-sounding text-to-speech on Raspberry Pi.

Install Piper:
    wget https://github.com/rhasspy/piper/releases/download/v1.2.0/piper_arm64.tar.gz
    tar -xzf piper_arm64.tar.gz
    # Download a voice model:
    wget https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/lessac/medium/en_US-lessac-medium.onnx
    wget https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/lessac/medium/en_US-lessac-medium.onnx.json

Update PIPER_PATH and VOICE_MODEL below to match where you installed them.

Fallback: If Piper isn't installed, uses espeak (simpler voice).
    sudo apt install espeak
"""

import subprocess
import os
import tempfile

# ⚠️ Update these paths to match your Piper installation
PIPER_PATH = os.path.expanduser("~/piper/piper")
VOICE_MODEL = os.path.expanduser("~/piper/en_US-lessac-medium.onnx")

# Whether we've confirmed Piper is available
_piper_available = os.path.exists(PIPER_PATH) and os.path.exists(VOICE_MODEL)

if _piper_available:
    print("[Speaker] Piper TTS ready.")
else:
    print("[Speaker] Piper not found. Falling back to espeak.")


def speak(text: str):
    """
    Converts text to speech and plays it through the speaker.
    Uses Piper if available, otherwise falls back to espeak.
    """
    if not text:
        return

    print(f"[Speaker] Speaking: {text}")

    if _piper_available:
        _speak_piper(text)
    else:
        _speak_espeak(text)


def _speak_piper(text: str):
    """Use Piper for high-quality offline TTS."""
    try:
        with tempfile.NamedTemporaryFile(suffix=".wav", delete=False) as f:
            wav_path = f.name

        # Pipe text into piper, output to WAV
        piper_proc = subprocess.Popen(
            [PIPER_PATH, "--model", VOICE_MODEL, "--output_file", wav_path],
            stdin=subprocess.PIPE,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )
        piper_proc.communicate(input=text.encode())

        # Play the WAV file
        subprocess.run(
            ["aplay", wav_path],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )

        os.unlink(wav_path)

    except Exception as e:
        print(f"[Speaker] Piper error: {e}. Falling back to espeak.")
        _speak_espeak(text)


def _speak_espeak(text: str):
    """Fallback TTS using espeak."""
    try:
        subprocess.run(
            ["espeak", "-v", "en", "-s", "150", "-p", "50", text],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )
    except FileNotFoundError:
        print(f"[Speaker] espeak not found. Cannot speak: {text}")
    except Exception as e:
        print(f"[Speaker] espeak error: {e}")
